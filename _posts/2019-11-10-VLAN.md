---
layout: article
title: How to VLAN
author :
mathjax: true
mermaid: true
chart: true
mathjax_autoNumber: true
tags: 网络 OpenWrt Howto
key: vlan
mode: immersive
header:
  theme: dark
article_header:
  type: overlay
  theme: dark
  background_color: '#ffffff'
  background_image:
    src: assets/background/hua.jpg
    gradient: 'linear-gradient(0deg, rgba(0, 0, 0 , .2), rgba(0, 0, 0, .2))'
---
计算机网络的教材对VLAN一笔带过，作业的却要用到交换机互联，之前看的VLAN的文章也没弄清楚，OpenWrt中VLAN的tagged还没有用过，就这样看着看着书就有了一个想法

<!--more-->
# 问题
![](https://i.loli.net/2019/11/13/q2cQyBfAGEN36au.png)
宿舍是上床下桌，没一张桌子下面有一个百兆的网口，通过负载均衡，很早就可以把网速跑到100Mbps了，这显然不够啊，自然而然想到连接相邻的两个床位的网口，这样就有300Mbps了，然而舍友是需要网口拨号的，所以如果需要长期占用的话偶尔肯定是不太方便的，所以需要交换机来扩展一下网口，这一步已经可以通过简单的修改下OpenWrt路由器的Switch来实现：
![](https://i.loli.net/2019/11/09/keOTDbEr3oYfc6S.png)
此时LAN4与WAN是“直通”的，效果上来说，就是LAN4也可以插网线用电脑拨号了，如果是要给路由器做双线接入的话，则需要添加VLAN，再把一个LAN口添加到新VLAN中，最后建立接口拨号即可：
![](https://i.loli.net/2019/11/13/KvUe9o8M64tLJqs.png)
上图就是将LAN3与LAN4作双线接入，通过VLAN分别对应到虚拟网卡eth0.3和eth0.4

然而，仅仅通过untagged只能实现“汇聚”，即能够达到100Mbps+的只有一台路由器而已，并没有实现“互通”，不仅如此，还要实现只用一根线连接不同床位下的路由器就完成多种连接，而VLAN的一个重要的功能就是实现交换机之间的互通
# 概念
首先还是OpenWrt的文档：[VLAN](https://openwrt.org/docs/guide-user/network/vlan/switch_configuration)，很早就读过，但是还是没弄清楚VLAN tagged的机制（没有具体的有解释的例子），所以这里结合华为的[文档](https://support.huawei.com/enterprise/zh/doc/EDOC1100033744/60b1f2f0)介绍下解决以上问题需要的概念

## VLAN Tag
首先需要理解VLAN主要是应用在交换机内部的，在数据帧进入交换机的时候可能会按照一定的**规则**被打上VLAN Tag以方便下一步的处理
![](https://download.huawei.com/mdl/imgDownload?uuid=865f3b452f3a4066ad15c05f8adf9f2d.png)

在一个VLAN交换网络中，以太网帧主要有以下两种形式：
- 有标记帧（Tagged帧）：加入了4字节VLAN标签的帧
- 无标记帧（Untagged帧）：原始的、未加入4字节VLAN标签的帧
常用设备中：
- 用户主机、服务器、Hub只能收发Untagged帧
- 交换机、路由器和AC既能收发Tagged帧，也能收发Untagged帧
- 语音终端、AP等设备可以同时收发一个Tagged帧和一个Untagged帧
为了提高处理效率，设备内部处理的数据帧一律都是Tagged帧

### 链路类型和接口类型
为了适应不同的连接和组网，设备定义了Access接口、Trunk接口和Hybrid接口3种接口类型，以及接入链路（Access Link）和干道链路（Trunk Link）两种链路类型，如下图所示
[](https://download.huawei.com/mdl/imgDownload?uuid=52f70f062ff6463e9250db359a3f4845.png)

上面提到的LAN4与WAN“直通”可以理解为相关的接口工作的Access模式下的情况


### Incoming & Outgoing
指的是数据帧到达接口而没有真正进入接口的时候，这有些抽象，举个例子：数据帧到达某一个接口时，路由器会对数据帧的VLAN情况做判断，如果符合通过的规则，则放行做后续处理，不符合则丢弃

### VID & PVID
VID也就是数据帧中的12bit的VLAN ID，表示该数据帧所属VLAN的编号，而PVID（Port Default VLAN ID）又称为缺省VLAN，用于和VID做比较来判断Tag的情况

### 接口-Tag处理规则
这里的收到报文也就是Incoming，发送也就是outgoing
- Access端口，PVID也就是该端口Untagged的VLAN ID
![](https://i.loli.net/2019/11/13/dmYj7sQTJHB5ZOy.png)
- Trunk端口，PVID为该端口tagged的VLAN ID，不同的数据帧是不一样的
![](https://i.loli.net/2019/11/13/AyCr467obxNFczX.png)
- Hybird端口
![](https://i.loli.net/2019/11/13/xFHasobWXJ7dvGk.png)

### OpenWrt VLAN
而OpenWrt的文档没怎么提及Access接口和Trunk接口，只有一句：
>  An untagged port can have only 1 VLAN ID
实际上当你尝试在当个接口上设置两个Untagged的时候是会报错的，但是对Tag机制有介绍

> - Tagged on “CPU (eth0)” means that the two VLAN ID tags used in this example (1, 2) are sent to the router CPU “as tagged data”. Remember: you can only send Tagged data to VLAN-aware devices configured to deal with it properly.
> - Untagged means that on these ports the switch will accept only the incoming traffic without any VLAN IDs (i.e. normal ethernet traffic). The switch will remove VLAN IDs on outgoing data in such ports. Each port can only be assigned as “untagged” to exactly one VLAN ID.
> - Off no traffic to or from the tagged ports of this VLAN ID will reach these ports.

其他的：很详细的VLAN的功能介绍（比较长）：[图文并茂VLAN详解](https://blog.51cto.com/6930123/2115373)