---
layout: article
title: 家用宽带的IPv6配置
author :
mathjax: true
mermaid: true
chart: true
mathjax_autoNumber: true
toc: true
tags : 网络 IPv6 路由器 OpenWrt
key: isp
mode: immersive
header:
  theme: dark
article_header:
  type: overlay
  theme: dark
  background_color: '#ffffff'
  background_image:
    gradient: 'linear-gradient(0deg, rgba(0, 0, 0 , .7), rgba(0, 0, 0, .7))'
    src: assets/background/qing.jpg
---

记录下自家宽带IPv6的现状及网关，OpenWrt路由器及防火墙的配置方法
<!--more--> 

不枉我每年寒暑假都回家看宽带的IPv6是否部署了，在2019年的暑假终于家里也可以用IPv6了，之前一直在教育网（CERNET2）的IPv6环境中，也熟悉了一些配置和使用方法，但是终究没有体验到IPv6的很多特性：

- 上级路由向本地路由分配PD地址

- 本地路由向下级设备分配公网IPv6地址

- 本地路由可以对IPv6防火墙做相对全面的管理

## 现状

就现在的情况而言，首先就是大量的路由器本身就不支持IPv6，尽管工信部于4月发文《关于开展2019年IPv6网络就绪专项行动的通知》，但路由器厂商并没有多少动静，据我所知华硕，网件，linksys之类的高端路由器很早就支持IPv6了，最近华为的部分路由器又陆续有固件的推送，也实现了IPv6的支持，其他的路由器主要也就靠刷机等方式获得IPv6支持

另外就是暂时在网络运营商一侧，光线入户到家庭网关（俗称光猫，做调制解调器），但是因为运营商还没有向家庭网关推送IPv6的配置，进而导致本地路由无法接入IPv6网络，如果运营商一侧已经提供了可用的IPv6网络，仅仅是没有推送设置的话，是可以自己动手设置下的

现在新开通的宽带附带的调制解调器与路由器一体的家庭网关可以不用路由器就实现IPv6的接入，不得不佩服运营商的良苦用心，如果考虑到家庭网关的无线性能，最好还是用个好一点的路由器做AP

更具体一点的信息可以参考工信部下属的单位发布的[家庭路由器设备IPv6支持度如何](https://www.chainnews.com/articles/710845252047.htm)，文中也列出了几款常见的路由器对IPv6配置所需的特性的支持情况

## 一些准备工作

因为有幸折腾过三家运营商的网络，以下都是按照经验来写的，需要些网络常识，如果有足够的折腾经历的话，跟着直觉走就是了

### 判断当前的网络拓扑情况

这一步关系到如何连接到家庭网关，首先是查看当前的直连的路由器的WAN口IP，如果是192开头的IP地址的话那么家庭网关就是拨号设备，那么可以按照WAN口的IP打开家庭网关的界面

如果是10开头的IP地址或者路由器的联网方式是PPPoE的话，那么家庭网关就只充当调制解调器，连接方式的话就相对复杂些：

- 如果家庭网关开启了无线功能的话，连接该WiFi，按照IP打开管理界面

- 使用网线直连家庭网关，修改有线网卡IP为手动，并设置到网关的同一网段下，按照IP打开管理界面

### 调制解调器设置

查看/修改调制解调器的宽带方面的设置，一般是需要以超级用户（管理员）登陆的，用户名和密码可以用路由器的型号到网络上搜索，也可以尝试问运营商客服，这一步很多人称为光猫破解

![](https://img.vim-cn.com/ad/6019e51a8ea6271dc3b2a46d6f95cfd7792627.png)

登陆之后到某一选项卡的界面如上，在做进一步的修改之前有个小问题需要留意，就是宽带拨号的账号和密码，为了避免之后换路由器导致账号丢失，建议还是记下来

> 如果弄丢了的话通过手机APP，用业务预留的手机号可以找回

至于对于查看网页上这种显示*号的密码，可以使用Chrome的检查功能，找到密码所在的位置，修改某处的password为text

![](https://img.vim-cn.com/9f/16fe39c439e19793c26e8cf96c68767cdb0ab4.png)

界面上需要注意的是IP协议版本和连接模式两项，默认情况下一般是IPv4，连接模式为路由，既然是要添加IPv6支持，协议部分当然要修改为IPv4/IPv6了，而连接模式就要看个人的倾向了

网上的教程大多数都是改的桥接，因为要使用路由器拨号和分配地址来获得更多的自主权

如果是打算使用家庭网关作为IPv6的路由器使用的话就把连接模式设置为路由就好了，可能在地址获取方式上要勾选一个PD，方便路由向下级设备分配地址

之后一般要重启设备之类的

### 路由器的设置

如果改了桥接的话，路由器输入宽带拨号的账号和密码，等一段时间或者重启之后就可以连接上网络了，如果路由器本身有IPv6支持的话，如果可以看到公网的IPv6地址的话，那么已经成功让路由器的WAN端完成了配置

下图就是我家里的一台华为路由器成功接入IPv6网络的情况，这类支持的比较好的设备基本上到这一步就没什么问题了

![](https://img.vim-cn.com/c6/9ce75910ebb63c1fd47556044f9d35ddd732a0.png)

之后可以用设备打开[IPv6测试](http://www.test-ipv6.com/)检查是否成功接入，以及使用[东北大学网络测速](http://speed.neu6.edu.cn/)测试IPv6的上下行的速度如何

## 一些可能的问题

就在我设置完成家庭网关和路由器之后，发现下级设备的端口并无法从外网访问，比如说使用手机的iperf3客户端连接PC上的iperf3服务器测速会连接不上，ping也是不通的，至于PT需要打开防火墙的端口便于通信以及搭建服务器之类的也并没一步到位

## 防火墙设定

因为设备几乎都暴露在公网上，但是考虑到设备的连接性，防火墙需要做必要的取舍

### 外网访问内网设备

### 主路由和二级路由互通