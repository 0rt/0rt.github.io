---
layout: article
title: IPv6与路由
author :
mathjax: true
mermaid: true
chart: true
mathjax_autoNumber: true
toc: true
tags : 网络 IPv6 路由器
mode: immersive
header:
  theme: dark
article_header:
  type: overlay
  theme: dark
  background_color: '#ffffff'
  background_image:
    gradient: 'linear-gradient(0deg, rgba(0, 0, 0, .7), rgba(0, 0, 0, .7))'
    src: assets/background/thinkworld.jpg
---

主要介绍了之后使用的到的IPv6基础知识以及内网配置IPv6方法的思路，以及一种接入IPv6的简单方法
<!--more-->

## 前言

来到大学之前看到关于学校网络一句这样的话

> 学校的规矩很扯淡，大一没有校园网账号，没法上网查资料，但是宿舍的网线插口只要连上电脑就有IPv6地址，操作一下就可以校园网免流量上网

嗯，知识改变命运

初入大学，当时听学长说六维空间开放注册，从小对PT憧憬的我自然是很激动啦，学长说无线网络不能访问IPv6，只有靠学校的有线校园网才行，可是当时又没有校园网账号，连电脑都是借的，突发奇想到图书馆拔掉了查询台的网线，但是直到半年后我才知道，学校图书馆的内网和校园网都是分离的，短短几个小时的开放注册时间在几次尝试无果之后就错过了，第一次接触到IPv6，只留下了一堆问题，后面便是开始遍历学校的信息处网站，学校的论坛，看了些文章，又大概有了一些了解，不过还是处于一知半解的状态。

后面很幸运的是，家里的旧路由器Newifi mini，网上有各种固件可以刷，其中就有大名鼎鼎的OpenWRT，后面经过学长推荐又刷入了LEDE，自己动手实现了宿舍的IPv6网络的无线覆盖，而网络折腾之路也就此开始。

在这里也就是做些整理

## IPv6

众所周知，IPv4的地址早已枯竭，公网IP难求，平时我们所获得的IPv4地址都是通过层层NAT（Network Address Transfer）而来的，而IPv6完全有能力为每个设备分配一个公网IP，于是我们可以不再需要NAT，从而非常方便的实现点到点的直接通信。

近些年IPv6的普及速度加快，不仅仅是各地的宽带陆续支持了IPv6连接，连4G网络也可以分配到IPv6地址了，而教育网，作为试验田，早就开始了IPv6部署——CERNET2，并且以不限流不限速吸引同学们使用和学习IPv6网络，以我的学校为例，宿舍IPv6带宽被限制在50Mbps，不限流量，并且可以很轻松的访问国际互联网上的IPv6资源，同时还有教育网，公网的IPv6 PT可用，可谓是在校生的一大福利。

那么下面问题来了，为什么直接使用普通的路由器不能让局域网中的接入IPv6网络呢？

首先就是现在市面上绝大多数的家用路由器本身并不支持IPv6，一般都要通过刷机到更加高级的系统才会支持，或者用更加专业的设备。

其次，即使刷机，就部分学校的IPv6接入方式又决定了配置的不便，这里又有些关于计算机网络的基础知识

> **一. IPv6地址分配方式**
>
> IPv6有一个功能叫 **SLAAC**（无状态自动分配:[Stateless Auto Configuration](https://tools.ietf.org/html/rfc2462)），简单点说，就是可以不借助DHCP服务器实现IP地址的分配，插上网线就能上网。
>
> 系统起来后，就会为每个网卡生成一个Link-Local的IP地址，简单点说就是一个固定的前缀加上mac地址，由于mac地址全球唯一，所以这样构成的IP地址是唯一的，有了这个地址后，就可以局域网进行通信了，但是这种地址路由器是不会转发（NAT）的。
>
> 这种情况下在IPv6中没有NAT，设备的地址会不经修改地转发出去。由于设备的地址并不为路由所拥有，所以默认情况下路由并不会回应针对设备地址的NS请求。这样一来，上端路由就不知道这些IPv6地址对应什么链路层地址了，所以这些地址将被视为无效，由此发出的数据包将被丢弃。我们需要使用一些方法来让路由回应针对它下属设备地址的NS请求。
>
> 当然IP地址也可以由**DHCPv6**服务器来分配，这种方式分配叫做有状态分配（Stateful Auto Configuration），但是前提是服务器本身（在这里也就是路由器）获得的是一个**子网**。
>
> IPv6其实是带有用于解决“客户端需要一个子网，而不是单个地址”这个问题的方案的，叫做DHCP-PD。普通的DHCPv6只给客户端分配一个地址，而DHCP-PD会分配一个地址范围（比如一次分一个/60），这样客户端就可以知道这个范围就是自己的，不用担心冲突，于是可以自动完成地址分配。DHCP-PD还有一个好处就是IPv6服务商会把所有这个范围的地址直接路由到客户端去，也就是说服务商默认这个范围的地址都在你的路由上，因此不需要为子网地址发送NS了，服务商都知道了。
>
> 路由的官方固件都是需要DHCP-PD才能为子网配置IPv6的。而校园网没有这个功能，因此路由自带的IPv6功能不能用。**不光得手动选择地址，还得回应NS。**
>
> **1. Router Advertisement（以下简称RA）**
>
> 由网络内的IPv6路由器定期发送，用来告诉客户端这里有一个IPv6网关，可以开始IPv6配置了。包含默认路由地址、网络前缀、前缀长度、地址分配方式等。
>
> 如果网络里有路由器； 系统会通过广播的方式问路由器，路由器会返回一个子网前缀（也就是RA，后面有解释），类似于IPv4里面的192.168.0.0/16，系统将子网前缀和mac地址组合起来，构成了一个唯一的IP地址，这个IP地址可以通过路由器路由，也就是说，就算不做任何配置，系统启动起来后，网卡就一定会有IPv6地址，有了IPv6地址就可以通信。
>
> **2. Neighbor Solicitation （以下简称NS）**
>
> 用来寻找某IPv6地址所对应链路层地址。跟IPv4中的ARP类似。在设备首次遇见本子网内的某个IPv6地址时会发送，以此建立链路层的对应关系。如果目标设备无回应，则将此IPv6地址标为无效，丢弃掉包含此地址的数据包。下次与此地址通信时又会再次发送。
>
> **二、IPv6地址**
>
> IPv6里面有三种地址类型；
>
> - Unicast: 单播地址，就是我们常用的地址，唯一标识一个网络接口
> - Anycast: 任意播（直译有点怪），一类特殊的IP地址，多个网络接口（不同的设备）都配上相同的地址，往这个地址发送数据的时候，路由器会只发往其中的一个接口，一般发往最近的那一个。（这个好像对实现负载均衡比较有用）
> - Multicast: 多播地址，代表一类unicast的集合，但往这个地址发送数据的时候，会将数据发给属于这个多播组的每个unicast地址。
>
> 现有的 IP 地址被分配成如下几大类：
>
> | 类型 | 前缀 | IPv6 表示方法 |
> | :-- | :-- | :-- |
> | Unspecified | 00...00 (128 位) | ::/128 |
> | Loopback | 00...01 (128 位) | ::1/128 |
> | Multicast | 11111111 | FF00::/8 |
> | Link-Local unicast | 1111111010 | FE80::/10 |
> | Unique local address | 1111110 | FC00::/7 |
> | Global Unicast | 所有其它 |  |
>
> - 全 0 的地址::/128 为未定义地址，大家不要去使用
> - 除了最后一位是 1，其它都是 0 的地址::1/128 为本地环回地址，同 IPv4 里面的 127.0.0.1
> - FF00::/8 这个网段的地址都是多播地址
> - FE80::/10 为 Link-Local 的单播地址，这类地址不能穿过路由器
> - FC00::/7 为本地的单播地址，可以穿过本地的路由器，但不能穿过外网的路由器，即只可以在本地使用，和 IPv4 里面的 192.168.0.0/16 相似
> - **全局的单播地址目前只有 2000::/3 开头的可以被申请使用，其它的都被预留了**
>
> IPv6要求所有的单播（unicast）地址的子网必须是64位的，即下面这种格式：
>
> |  64 bits  |   64 bits    |
> | :-------: | :----------: |
> | subnet ID | interface ID |
>
>
> 如果子网的长度不是64位的话，会导致一些IPv6的功能不可用，详情请参考[IPv6 Unicast Address Assignment Considerations](https://tools.ietf.org/html/rfc5375)。
>
> Interface ID为[Modified EUI-64](http://standards.ieee.org/develop/regauth/tut/eui64.pdf)格式，标准里面提供了如何将48位mac地址转换成EUI-64格式的方法。
>
> IPv6标准要求单播地址的子网必须是64位的，主要是为了简化IPv6的管理，同时路由也方便，毕竟现在CPU都是64位的，如果子网号超过64位的话，会给路由造成一定的困难，同时64位的接口ID也比较容易存放一个UUID，比如可以容纳48位的mac地址，为Stateless Auto Configuration的地址分配提供了足够的空间。

## 内网配置IPv6的方法

为什么这么麻烦？

按照IPv6的规范，路由器获得的应该是一个子网范围而不是单独的一个地址，在获得子网范围的情况下就可以通过有状态或者无状态分配的方式使得下层设备获得IPv6地址；

但是在一些学校联网是需要认证的，而且一次认证只会获得一个IPv6地址，究其原因，PPPoE认证是基于设备网卡的MAC的，认证之后，上级的交换机就会接受来自该MAC的通信，并且会分配一个IP地址与之绑定；

就个人所在的学校的情况如下：输入命令`` ifconfig ``就会得到形似下面的输出

```shell
pppoe-wan
...
inet6 addr: fe80::dcb8:cd0d:422:c123/10 Scope:Link
inet6 addr: 2001:xxxx:xxxx:xxxx:dcb8:cd0d:422:c123/64 Scope:Global
...
```

第一个其实是WAN口的本地IPv6地址，可以看到后64位```dcb8:cd0d:422:c123```也就是由网卡的MAC经过转换而来，而第二个就是认证之后分配的一个地址，可以看到后64位是一样的，可以判断这是由SLAAC分配而来的，而2001开头就表明了这是一个全局的单播IPv6地址。

接着查看IPv6的路由表可以看到这么一条

```
default from 2001:xxxx:xxxx:xxxx::/64 via fe80::96db:daff:fe3e:8fcf dev pppoe-wan
```

这里的```fe80::96db:daff:fe3e:8fcf```就是上级交换机的端口的IPv6地址了，因为本机的WAN口正是连接在上级交换机上。

经过一代代人的探索，方法也有好几种，各有优缺，比较如下：

### 基于Ndppd+Radvd的子网划分
在学校给的子网里，强行给自己划一个更小的子网

优势：
- 符合IPv6规范，路由就充当“IPv6路由”的作用，足够优雅
- 地址分配可以自己控制，可以在地址里玩出花
- 设备地址都在确定的范围里，可以方便地为自己的子网添加防火墙规则等
- 可以用于IPv6需要认证的网络
- 如果路由支持IPv6硬件转发或者CTF的话，可以极大减少CPU占用率
- 保留了IPv6自带内网穿透的特性

劣势：
- 需要上级交换机能对未知的IPv6地址发出NS
- 路由上需要的软件比较多
- Android迄今为止都不支持DHCPv6，故需要root后用Tasker之类的软件在WiFi连上后手动添加IPv6地址方可使用
- 有时候路由自带的防火墙规则会画蛇添足，要想办法阻止路由系统添加IPv6的防火墙规则

### 基于6relayd的中继
把WAN的IPv6数据包改MAC代理到LAN里面来，再把LAN的数据包改MAC代理到WAN去

优势：
- 使用灵活，上能骗交换机下能骗客户端，几乎可以用于一切情况
- 若是上级使用SLAAC，则路由下也仍然是SLAAC（废话，因为就是代理来的）客户端兼容性好，Android也能用
- 可以用于IPv6需要认证的网络
- 保留了IPv6自带内网穿透的特性
- 配置比较简单

劣势：
- 打破了内外网的分隔，外网IPv6一旦出现NS风暴一类的问题，内网也要遭殃
- 客户端地址分散，路由难以管理自己下面的IPv6客户端
- 防火墙规则不好使了，要是自己想玩点什么就无从下手。而且为了使用这个方法，系统的防火墙规则也需要清除
- 在用户空间转发数据包，开销比内核直接转发大（一点点？）若路由支持IPv6硬件转发或者CTF，差距就大了
- 在访问以前未访问过的IPv6地址时会有一个迷の卡顿

### 搭建IPv6网桥
在WAN和LAN之间架一个只允许IPv6数据包通过的桥

优势：
- 无论是上级SLAAC还是DHCPv6，都能一起解决，无需担心监听端口被占用
- 保留了IPv6自带内网穿透的特性
- 配置相当简单

劣势：
- 不能用于IPv6要认证的网络，因为MAC地址直接暴露给上级了
- 需要改VLAN设置。如果WAN口是eth0这种untag的情况则不能使用，否则瞬间爆炸
- 客户端地址分散，路由难以管理自己下面的IPv6客户端
- 打破了内外网的分隔，外网IPv6一旦出现NS风暴一类的问题，内网也要遭殃
- 也是软件转发的，效率比不上硬件转发或者CTF加速（但是比用户空间好一点吧）

### IPv6 NAT
类似于对IPv4的处理方法
优势：

- 路由有能用的IPv6的话，客户端就一定能用
- 可以在内网使用SLAAC分配地址，让Android支持
- 可以用于IPv6需要认证的网络

劣势：

- IPv6自带穿透的特性被吃了，对于PT而言是极大的劣势，自己建站什么的也很麻烦
- 梅林用的内核版本没有IPv6 NAT功能（需要Linux 3.9以上，而博通也不知道在想什么居然还用Linux 2.6）直接pass掉

以上主要是参考Koolshare论坛的帖子，主要针对的是路由器的merlin固件，但是其中所述的原理部分写的很详细

原帖链接：[【进阶类教程】多种无PD的情况下给内网配置IPv6的方法](http://koolshare.cn/forum.php?mod=viewthread&tid=46415&extra=&highlight=ipv6&page=1)

以上方法也有在OpenWRT路由器上面的实现，考虑到省事，个人还是用的IPv6 NAT（NAT6）,基于NAT6还可以做些其他的操作，之后有文章再叙述。

## 一种获得IPv6连接的方法

就简单的分享一下吧

1. 注册一个v4转v6的OpenVPN的账号http://6plat.org/
2. 连接上IPv6的北邮人
3. 解除UT中的IP过滤

然后就可以在家里用教育网的PT了

至于IPv6的速度，不好说，时快时慢，不过用来连接PT的traceker是足够了

但是如果有人也用IPv4在上传同一个资源的话 ，速度还是比较可观的

偶尔拿来上下Google也是不错的
