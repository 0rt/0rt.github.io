# IPv6 NAT

在中已经阐述了IPv6的基本情况，在大多数情况下IPv6 NAT还是适用的，下面就个人的情况简单介绍下设置步骤，感兴趣的话还可以看下原理，至于为什么要懂一点点原理，因为遇到什么情况都有可能，可以参考第二个参考链接里的 2018 Version，原理依旧适用，只是实现方法略有不同

## 我的设备

**路由器**：Newifi mini

**系统**：LEDE 17.0.4

**网络**：校园网，PPPoE IPv4/IPv6双栈，SLAAC

## 准备

- 一台刷了OpenWRT或者LEDE，pandorabox的路由器（OpenWRT建议14.07以上，系统均建议官网纯净版本，网络上的个人编译版可能会遇到一些解释不清的问题）
- 安装了LuCi界面
- 支持IPv6的网络
- SSH客户端（ex：Putty，Linux终端，Finalshell）

## 配置

### 确定路由器能连接到IPv6网络

在路由器的管理页面 http://192.168.1.1/cgi-bin/luci/admin/network/network 中（LAN IP不同路由器可能不一样）设置WAN口为你的上网方式，连接之后就可以获取IPv6地址，如果是如下这样的

**IPv6:** fe80::dcb8:cd0d:422:c123/128 

看过之前教程的人可能会问了，这个和说好的IPv6单拨地址不一样啊，但是实际上只要在SSH连接后输入命令`` ifconfig ``就会得到形似下面的输出

```shell
pppoe-wan
...
inet6 addr: fe80::dcb8:cd0d:422:c123/10 Scope:Link
inet6 addr: 2001:xxxx:xxxx:xxxx:dcb8:cd0d:422:c123/64 Scope:Global
...
```

可以看到后64位```dcb8:cd0d:422:c123```是一样的，并且后缀也表明了，此时pppoe-wan已经获得了全局单播的IPv6地址，LuCi界面上的只是一个内部地址而已，其实在 http://192.168.13.1/cgi-bin/luci/admin/status/overview 的IPv6 WAN Status中也可以看到详细的IPv6连接信息以及较高版本的OpenWRT中的wan6接口下也可以看到获得的IPv6地址

那么接下就是测试下IPv6的连接性，只需要运行``ping6 ipv6.mirrors.ustc.edu.cn``

如果得到了类似的输出就说明IPv6网络是可用的

```shell
root@LEDE:~# ping6 ipv6.mirrors.ustc.edu.cn
PING ipv6.mirrors.ustc.edu.cn (2001:da8:d800:95::110): 56 data bytes
64 bytes from 2001:da8:d800:95::110: seq=0 ttl=52 time=124.260 ms
64 bytes from 2001:da8:d800:95::110: seq=1 ttl=52 time=43.021 ms
64 bytes from 2001:da8:d800:95::110: seq=2 ttl=52 time=43.080 ms
64 bytes from 2001:da8:d800:95::110: seq=3 ttl=52 time=43.020 ms
64 bytes from 2001:da8:d800:95::110: seq=4 ttl=52 time=42.940 ms
...
```

### 一键配置脚本

这种东西最暴力了，可能是社区上普遍觉得这个不利于学习其中的原理吧，毕竟要做其他的操作不懂原理难免会出问题，个人因为经常刷机折腾，所以这个就应运而生了，直接复制粘贴到SSH窗口等待连接断开重启就好，省时省力

```shell
opkg update && opkg install kmod-ipt-nat6

echo "net.ipv6.conf.default.accept_ra=2" >> /etc/sysctl.conf
echo "net.ipv6.conf.all.accept_ra=2" >> /etc/sysctl.conf

uci set network.globals.ula_prefix="$(uci get network.globals.ula_prefix | sed 's/^./d/')"
uci commit network
uci set dhcp.lan.ra_default='1'
uci commit dhcp

touch /etc/init.d/nat6
chmod +x /etc/init.d/nat6

cat > /etc/init.d/nat6 << EOF
#!/bin/sh /etc/rc.common

START=75

ip6tables -t nat -I POSTROUTING -s \`uci get network.globals.ula_prefix\` -j MASQUERADE
route -A inet6 add 2000::/3 \`route -A inet6 | grep ::/0 | awk 'NR==1{print "gw "\$2" dev "\$7}'\`
EOF

/etc/init.d/nat6 enable
reboot
```



#### 安装NAT6模块

首先是更新软件源，偶尔连接性不太好可能速度比较慢，可以参考 [USTC Mirro Help](http://mirrors.ustc.edu.cn/help/lede.html) 替换软件源，这里安装的就是负责IPv6转发的NAT6模块，安装完成之后会有正常的输出

```shell
opkg update && opkg install kmod-ipt-nat6
```

#### 网络配置

以下均在SSH中输入运行，主要是RA的配置，第三行是修改内网IPv6地址的前缀，否则许多软件会默认使用 IPv4 (他以为你的 IPv6 地址不通外网），其间也读过IPv6 NAT其他的代码，这里面最重要的是开启LAN口的RA

```shell
echo "net.ipv6.conf.default.accept_ra=2" >> /etc/sysctl.conf
echo "net.ipv6.conf.all.accept_ra=2" >> /etc/sysctl.conf

uci set network.globals.ula_prefix="$(uci get network.globals.ula_prefix | sed 's/^./d/')"
uci commit network
uci set dhcp.lan.ra_default='1'
uci commit dhcp
```

#### 添加nat6脚本

因为nat6脚本中设置的是防火墙规则和IPv6路由表，所以在重启之后就会失效，需要添加到开机启动项中，下面依次是创建文件，赋予执行的权限，使用vi编辑器进行编辑，输入完第三行命令之后就进入了vi编辑器的编辑，一开始进入是vi编辑器的命令行模式（Command Mode），需要按下``I``键进入插入模式（Insert Mode），之后就是复制下面的脚本粘贴到SSH窗口中，按下``Esc``键退出Insert Mode，输入``:wq!``便保存了编辑的内容并退出。

至于vi编辑器是一个非常强大的命令行编辑器，具体可以搜索学习下

```shell
touch /etc/init.d/nat6
chmod +x /etc/init.d/nat6
vi /etc/init.d/nat6
```

#### 脚本内容

这里就是添加NAT6到防火墙规则中，另外在IPv6路由表中添加规则，使所有的全球可路由IPv6地址走NAT6的网关，从而完成流量的NAT，其实我们还可以用这个规则来实现其他的功能，之后的文章会说明。因为IPv4的NAT已经是约定俗成了，所以并不是这么的显性。

```shell
#!/bin/sh /etc/rc.common

START=75

ip6tables -t nat -I POSTROUTING -s `uci get network.globals.ula_prefix` -j MASQUERADE
route -A inet6 add 2000::/3 `route -A inet6 | grep ::/0 | awk 'NR==1{print "gw "$2" dev "$7}'`
```

#### 启用并重启

开启开机启动项，重启

```shell
/etc/init.d/nat6 enable
reboot
```
## 参考

[TUNA](https://github.com/tuna/ipv6.tsinghua.edu.cn/blob/master/openwrt.md)

[XDOSC](https://gitlab.com/XDOSC/WIFI/wikis/tips/ipv-6-router)