---
layout: article
title: Linux中的ECMP
mathjax: true
mermaid: true
chart: true
mathjax_autoNumber: true
toc: true
mode: immersive
tags: 网络 Linux
key: nat6
header:
  theme: dark
article_header:
  type: overlay
  theme: dark
  background_color: '#ffffff'
  background_image:
    src: https://img.vim-cn.com/b9/3652bb519e2f632b0a459461d2779a588e92b4.svg
    gradient: 'linear-gradient(0deg, rgba(0, 0, 0 , .7), rgba(0, 0, 0, .7))'
---
因为偶然发现了ECMP这种负载均衡的方法，然后查了些资料，这里整理下

<!--more-->
## 偶然的发现

这里保留当时的发现过程：（当时发现了这个功能非常开心，现在来看部分内容不准确）

只在K2P OpenWrt 18.06上面实践过，对LEDE 17.01无效

下面是在操作一番之后的路由表，对IPv6的测速显示网速翻了四倍

```shell
root@OpenWrt:~# ip -6 route | grep pppoe
default from 2001:250:1006:dff0::/64 via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN4 proto static metric 512 pref medium
2000:::/3 dev pppoe-VWAN4 proto static metric 256 pref medium
        nexthop via fe80::96db:daff:fe3e:8fcf dev pppoe-wan weight 1
        nexthop via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN2 weight 1
        nexthop via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN3 weight 1
        nexthop via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN4 weight 1
```

大致可以看出这已经是做了负载均衡，需要的只是安装好luci-app-mwan3，简单操作一下路由表，这里的网关地址和dev需要看具体情况

2000::/3 就是IPv6的单播（Unicast）地址了，在不做任何操纵的情况下，无PD的路由表（单拨）

```shell
default from 2001:250:1006:dff0::/64 via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN3 proto static metric 512 pref medium
2001:250:1006:dff0::/64 dev pppoe-VWAN3 proto static metric 256 pref medium
...
```
之后通过下面两条常规的添加路由表条目的命令：
```shell
route -A inet6 add 2000::/3 gw fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN2
route -A inet6 add 2000::/3 gw fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN3
```
发现路由表就出现了nexthup和负载均衡中的weight标记

```shell
root@OpenWrt:~# ip -6 route | grep pppoe
default from 2001:250:1006:dff0::/64 via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN3 proto static metric 512 pref medium
2000::/3 dev pppoe-VWAN3 proto static metric 256 pref medium
        nexthop via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN2 weight 1
        nexthop via fe80::96db:daff:fe3e:8fcf dev pppoe-VWAN3 weight 1
...
```

类似的网关添加过程对IPv4效果并不好，这里稍后再细说

之后还需要修改一下防火墙，这里用的还是NAT6中的那条命令

因为对路由表的修改在路由器重启之后会重置，所以还是要添加到开机的启动脚本或者添加到自定的防火墙规则之中，如果已经在NAT6配置过程中配置好了的话这一步就可以忽略了

```shell
ip6tables -t nat -I POSTROUTING -s `uci get network.globals.ula_prefix` -j MASQUERADE
```

实测的峰值速度可以到达双网口的满速，但是一样的问题，在UT，IDM，Thunder这种多线程下载软件下轻松满速，而在YouTube视频应用下，只有半速（甚至包括用IDM下载的情况下）

目前最新版本的mwan3也开始支持IPv6多拨了，但是个人还是觉得日常使用的话用以上的方法更加快捷，不过需要对网络有一定的了解，下面是一段针对IPv6 NAT的多拨hotplug脚本，用了一些OpenWrt开发时推荐的写法，比较实验性

```shell
#!/bin/sh
[ "$ACTION" = ifup ] || exit 0
ifaces=$(ubus call network.interface dump | jsonfilter -e '$.interface[@.proto="dhcpv6" && @.up=true].interface')
for iface_6 in $ifaces
do
  [ "$INTERFACE" = $iface_6 ]  || continue
  devices=$(ubus call network.interface dump | jsonfilter -e '$.interface[@.proto="dhcpv6" && @.up=true].device')
  ipv6_gw=$(ifstatus $iface_6 | jsonfilter -e '$.route[1].nexthop')
  for ipv6_dev in $devices
  do
    status=$(route -A inet6 add 2000::/3 gw $ipv6_gw dev $ipv6_dev 2>&1)
    logger -t NAT6 "Gateway: $ipv6_dev: Done $status"
  done
  exit 0
done
```

## Linux内核中ECMP

| Linux Kernel    | OpenWrt 内核版本   | ECMP变更                      | ECMP形式                                     |
| --------------- | ----------------- | ----------------------------- | -------------------------------------------- |
| 1997 \| 2.1.68  |                   | IPV4 ECMP 加入内核            | L3 Per-packet + route cache -> L3 Per-flow   |
| 2007 \| 2.6.23  |                   | IPV4 multipath cached 移除    | L3 Per-packet + route cache -> L3 Per-flow   |
| 2012.9 \| 3.6   |                   | IPV4 route cache 被移除       | L3 Per-packet -> L3 Per-packet               |
| 2012.10 \| 3.8  |                   | IPV6 ECMP 加入内核            | IPv6 Flowlabel -> L4 Per-flow                |
| 2015.9 \| 4.4   | 15.05 \| 3.18     | IPV4 multipath 特性重新被加回 | L3 Per-packet + L3 hash -> L3 Per-flow       |
| 2016.4 \| 4.7   |                   | IPV4 ECMP 增加邻居健康检查    |                                              |
| 2017.2          | 17.01 \| 4.4      |                               |                                              |
| 2017.3 \| 4.12  |                   | IPV4 ECMP 增加 L4 Hash        | L3 Per-packet + L3/L4 hash -> L3/L4 Per-flow |
| 2017.11 \| 4.14 |                   | IPV6 ECMP: ICMPv6 修复        |                                              |
| 2018.4 \| 4.16  |                   | IPv6 ECMP: 支持指定权重       |                                              |
| 2018.7          | 18.06 \| 4.9/4.14 |                               |                                              |
| 2018.10 \| 4.19 |                   |                               |                                              |